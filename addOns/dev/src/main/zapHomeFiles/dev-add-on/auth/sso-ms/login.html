<!DOCTYPE html>
<html lang="en">
<head>
	<title>Mock Microsoft Authentication</title>
	<link href="/tutorial.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div class="squareContainer">
	<svg xmlns="http://www.w3.org/2000/svg" width="108" height="24" viewBox="0 0 108 24"><title>assets</title>
	<path d="M44.836,4.6V18.4h-2.4V7.583H42.4L38.119,18.4H36.531L32.142,7.583h-.029V18.4H29.9V4.6h3.436L37.3,14.83h.058L41.545,4.6Zm2,1.049a1.268,1.268,0,0,1,.419-.967,1.413,1.413,0,0,1,1-.39,1.392,1.392,0,0,1,1.02.4,1.3,1.3,0,0,1,.4.958,1.248,1.248,0,0,1-.414.953,1.428,1.428,0,0,1-1.01.385A1.4,1.4,0,0,1,47.25,6.6a1.261,1.261,0,0,1-.409-.948M49.41,18.4H47.081V8.507H49.41Zm7.064-1.694a3.213,3.213,0,0,0,1.145-.241,4.811,4.811,0,0,0,1.155-.635V18a4.665,4.665,0,0,1-1.266.481,6.886,6.886,0,0,1-1.554.164,4.707,4.707,0,0,1-4.918-4.908,5.641,5.641,0,0,1,1.4-3.932,5.055,5.055,0,0,1,3.955-1.545,5.414,5.414,0,0,1,1.324.168,4.431,4.431,0,0,1,1.063.39v2.233a4.763,4.763,0,0,0-1.1-.611,3.184,3.184,0,0,0-1.15-.217,2.919,2.919,0,0,0-2.223.9,3.37,3.37,0,0,0-.847,2.416,3.216,3.216,0,0,0,.813,2.338,2.936,2.936,0,0,0,2.209.837M65.4,8.343a2.952,2.952,0,0,1,.5.039,2.1,2.1,0,0,1,.375.1v2.358a2.04,2.04,0,0,0-.534-.255,2.646,2.646,0,0,0-.852-.12,1.808,1.808,0,0,0-1.448.722,3.467,3.467,0,0,0-.592,2.223V18.4H60.525V8.507h2.329v1.559h.038A2.729,2.729,0,0,1,63.855,8.8,2.611,2.611,0,0,1,65.4,8.343m1,5.254A5.358,5.358,0,0,1,67.792,9.71a5.1,5.1,0,0,1,3.85-1.434,4.742,4.742,0,0,1,3.623,1.381,5.212,5.212,0,0,1,1.3,3.729,5.257,5.257,0,0,1-1.386,3.83,5.019,5.019,0,0,1-3.772,1.424,4.935,4.935,0,0,1-3.652-1.352A4.987,4.987,0,0,1,66.406,13.6m2.425-.077a3.535,3.535,0,0,0,.7,2.368,2.505,2.505,0,0,0,2.011.818,2.345,2.345,0,0,0,1.934-.818,3.783,3.783,0,0,0,.664-2.425,3.651,3.651,0,0,0-.688-2.411,2.389,2.389,0,0,0-1.929-.813,2.44,2.44,0,0,0-1.988.852,3.707,3.707,0,0,0-.707,2.43m11.2-2.416a1,1,0,0,0,.318.785,5.426,5.426,0,0,0,1.4.717,4.767,4.767,0,0,1,1.959,1.256,2.6,2.6,0,0,1,.563,1.689A2.715,2.715,0,0,1,83.2,17.794a4.558,4.558,0,0,1-2.9.847,6.978,6.978,0,0,1-1.362-.149,6.047,6.047,0,0,1-1.265-.38v-2.29a5.733,5.733,0,0,0,1.367.7,4,4,0,0,0,1.328.26,2.365,2.365,0,0,0,1.164-.221.79.79,0,0,0,.375-.741,1.029,1.029,0,0,0-.39-.813,5.768,5.768,0,0,0-1.477-.765,4.564,4.564,0,0,1-1.829-1.213,2.655,2.655,0,0,1-.539-1.713,2.706,2.706,0,0,1,1.063-2.2A4.243,4.243,0,0,1,81.5,8.256a6.663,6.663,0,0,1,1.164.115,5.161,5.161,0,0,1,1.078.3v2.214a4.974,4.974,0,0,0-1.078-.529,3.6,3.6,0,0,0-1.222-.221,1.781,1.781,0,0,0-1.034.26.824.824,0,0,0-.371.712M85.278,13.6A5.358,5.358,0,0,1,86.664,9.71a5.1,5.1,0,0,1,3.849-1.434,4.743,4.743,0,0,1,3.624,1.381,5.212,5.212,0,0,1,1.3,3.729,5.259,5.259,0,0,1-1.386,3.83,5.02,5.02,0,0,1-3.773,1.424,4.934,4.934,0,0,1-3.652-1.352A4.987,4.987,0,0,1,85.278,13.6m2.425-.077a3.537,3.537,0,0,0,.7,2.368,2.506,2.506,0,0,0,2.011.818,2.345,2.345,0,0,0,1.934-.818,3.783,3.783,0,0,0,.664-2.425,3.651,3.651,0,0,0-.688-2.411,2.39,2.39,0,0,0-1.93-.813,2.439,2.439,0,0,0-1.987.852,3.707,3.707,0,0,0-.707,2.43m15.464-3.109H99.7V18.4H97.341V10.412H95.686V8.507h1.655V7.13a3.423,3.423,0,0,1,1.015-2.555,3.561,3.561,0,0,1,2.6-1,5.807,5.807,0,0,1,.751.043,2.993,2.993,0,0,1,.577.13V5.764a2.422,2.422,0,0,0-.4-.164,2.107,2.107,0,0,0-.664-.1,1.407,1.407,0,0,0-1.126.457A2.017,2.017,0,0,0,99.7,7.313V8.507h3.469V6.283l2.339-.712V8.507h2.358v1.906h-2.358v4.629a1.951,1.951,0,0,0,.332,1.29,1.326,1.326,0,0,0,1.044.375,1.557,1.557,0,0,0,.486-.1,2.294,2.294,0,0,0,.5-.231V18.3a2.737,2.737,0,0,1-.736.231,5.029,5.029,0,0,1-1.015.106,2.887,2.887,0,0,1-2.209-.784,3.341,3.341,0,0,1-.736-2.363Z" fill="#737373"/><rect width="10.931" height="10.931" fill="#f25022"/><rect x="12.069" width="10.931" height="10.931" fill="#7fba00"/><rect y="12.069" width="10.931" height="10.931" fill="#00a4ef"/><rect x="12.069" y="12.069" width="10.931" height="10.931" fill="#ffb900"/></svg>

	<form method="post">
	<div id="p1">
		<h2 id="p1-signin">Sign in</h2>

		<div id="p1-result"><!-- RESULT --></div>

		<input type="hidden" id="service" name="service" value="<!-- SERVICE -->" />
		<table style="border: none;">
		<tr id="p1-unamerow">
			<td><input id="i0116" name="user" type="text" placeholder="Email, phone, or Skype"></td>
		</tr>
		<tr id="p1-noaccrow">
			<td>
			No account? <a href="#">Create one!</a>
			<p>
			<a href="#">Can't access your account?</a>
			</td>
		</tr>
		</table>
	</div>
	<div id="p2" hidden="hidden">
		<div id="p2-back"><br><table><tr><td><a href="#" onclick="resetform();">‚Üê</a><td><div id="p2-uname"></div></tr></table></div>
	
		<h2 id="p2-enterpwd">Enter password</h2>
		
		<div id="result"><!-- RESULT --></div>
		
		<table style="border: none;">
		<tr id="p2-pwdrow">
			<td><input id="i0118" name="passwd" type="password" placeholder="Password"></td>
		</tr>
		<tr id="p2-nopwd">
			<td>
			<a href="#">Forgot my password</a>
			</td>
		</tr>
		</table>
	</div>
	<div id="p3" hidden="hidden">
		<h2 id="p1-signin">Stay signed in</h2>
		
		Do this to reduce the number of times you are asked to sign in.
		<p>
		<input type="hidden" id="token" name="token" value="" />
		<input type="checkbox" id="KmsiCheckboxField" name="KmsiCheckboxField"/>
		Don't show this again.
	</div>
	<div id="p4" hidden="hidden">
		<h2 id="p4-title">Let's keep your account secure</h2>
		
		We'll help you to set up another way to verify it's you.
		<p>
		<a href="#">Use a different account?</a>
		<p>
		<a href="#">Learn more about verifying your identity</a>

		<table style="border: none;" width="100%">
			<tr>
				<td align="right">
					<button id="idSubmit_ProofUp_Redirect" type="button" value="submit" onclick="showproof();">Next</button>
				</td>
			</tr>
		</table>
		
	</div>
	<div id="p5" hidden="hidden">
		<div>
			<h2>No methods available</h2>
			
			Your organization requires that you register additional authentication methods, but no
			supported methods are currently enabled on your account.
			<p>
			Ask your admin to enable more authentication methods for you to select, or tell them to
			register one or more methods for you.
	
		</div>
		<div>
			<table style="border: none;" width="100%">
				<tr>
					<td width="60%"/>
					<td align="right">
						<button id="id__5" type="button" value="submit" onclick="gotoapp();">Done</button>
					</td>
				</tr>
				<tr>
					<td width="60%"/>
					<td align="right">
						<button type="button" value="submit" onclick="gotoapp();">Skip setup</button>
					</td>
				</tr>
			</table>
		</div>
	</div>
	<div id="mainbuttons">
		<table style="border: none;" width="100%">
			<tr>
				<td width="60%"/>
				<td align="right">
					<button id="idBtn_Back" style="display:none" type="button" value="submit" onclick="gotoapp();">No</button>
				</td>
				<td align="right">
					<button id="idSIButton9" type="button" value="submit" onclick="checkuser();">Next</button>
				</td>
			</tr>
		</table>
	</div>

	</form>

</div>
<div class="squareContainer">

	Sign-in options
	<ul>
		<li>username = test@test.com
		<li>password = password123
	</ul>
	
</div>
<script>
function geturlparam(param) {
	const params = new URLSearchParams(window.location.search);
	return params.get(param);
}

function checkuser() {
	var xhr = new XMLHttpRequest();
	var url = "user";
	const delay = geturlparam("ms-delay");
	if (delay) {
		url += "?ms-delay=" + delay;
	}

	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
	    if (xhr.readyState === 4 && xhr.status === 200) {
	        var json = JSON.parse(xhr.responseText);
	        
	        if (json.result === "OK") {
				showpasswd();
	        } else {
				// TODO add link and change colour
				const p1res = document.getElementById("p1-result");
				p1res.textContent = "We couldn't find an account with that username. Try another of TODO add link"
				p1res.hidden = false;
	        }
	    }
	};
	var data = JSON.stringify({
		"service": document.getElementById("service").value,
		"user": document.getElementById("i0116").value});
	xhr.send(data);
}
function showpasswd() {
	document.getElementById("p1").hidden = true;
	document.getElementById("p2").hidden = false;
	document.getElementById("idBtn_Back").style.display = "none";
	document.getElementById("p2-uname").textContent = document.getElementById("i0116").value;
	document.getElementById("p1-result").textContent = "";
	document.getElementById("i0118").focus();
	
	document.getElementById("idSIButton9").textContent = "Sign in";
	document.getElementById("idSIButton9").setAttribute('onclick', 'submitform();')
}
function resetform() {
	document.getElementById("p1").hidden = false;
	document.getElementById("p2").hidden = true;
	document.getElementById("idBtn_Back").style.display = "none";
	document.getElementById("idSIButton9").textContent = "Next";
	
	document.getElementById("idSIButton9").setAttribute('onclick', 'checkuser();')
}
function showstay() {
	document.getElementById("p2").hidden = true;
	document.getElementById("p3").hidden = false;
	document.getElementById("idBtn_Back").style.display = "block";

	document.getElementById("idSIButton9").textContent = "Yes";
	if (geturlparam("ms-sec") === "true") {
		document.getElementById("idSIButton9").setAttribute('onclick', 'checksecure();')
	} else {
		document.getElementById("idSIButton9").setAttribute('onclick', 'gotoapp();')
	}
}
function checksecure() {
	document.getElementById("p2").hidden = true;
	document.getElementById("p3").hidden = true;
	document.getElementById("p4").hidden = false;
	document.getElementById("mainbuttons").hidden = true;
	document.getElementById("idBtn_Back").style.display = "none";
}
function showproof() {
	document.getElementById("p2").hidden = true;
	document.getElementById("p3").hidden = true;
	document.getElementById("p4").hidden = true;
	document.getElementById("p5").hidden = false;
	document.getElementById("mainbuttons").hidden = true;
	document.getElementById("idBtn_Back").style.display = "none";
}
function gotoapp() {
	var url = "https://<!-- SERVICE -->?token=" + document.getElementById("token").value;
	const delay = geturlparam("ms-delay");
	if (delay) {
		url += "&ms-delay=" + delay;
	}
	window.location.replace(url);
}
function submitform() {
	// Remove previous messages
	let element = document.getElementById("result");
	while (element.firstChild) {
		element.removeChild(element.firstChild);
	}

	// Make the login request
	var xhr = new XMLHttpRequest();
	var url = "authorize?service=<!-- SERVICE -->";
	const delay = geturlparam("ms-delay");
	if (delay) {
		url += "&ms-delay=" + delay;
	}

	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
	    if (xhr.readyState === 4 && xhr.status === 200) {
	        var json = JSON.parse(xhr.responseText);
	        
	        if (json.result === "OK") {
	        	if (geturlparam("ms-stay") === "true") {
					document.getElementById("token").value = json.token
					showstay()
				} else {
		        	window.location.replace("https://<!-- SERVICE -->?token=" + json.token);
				}
	        } else {
	        	const h3 = document.createElement("h3");
	        	const textNode = document.createTextNode("Username or password incorrect");
	        	h3.appendChild(textNode);
	        	document.getElementById("result").appendChild(h3);
	        	resetform();
	        }
	    }
	};
	var data = JSON.stringify({
		"service": document.getElementById("service").value,
		"user": document.getElementById("i0116").value,
		"password": document.getElementById("i0118").value});
	xhr.send(data);
}

document.getElementById('i0116').onkeydown = function(e){
	if (e.keyCode == 13) {
		// Handle return key
		checkuser();
	}
};

document.getElementById('i0118').onkeydown = function(e){
	if (e.keyCode == 13) {
		// Handle return key
		submitform();
	}
};

document.getElementById("i0116").focus();

</script>
</body>
</html>
